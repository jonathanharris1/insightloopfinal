<% volume_options = [18, 25, 32, 45] %>
<% volume_pct = volume_options.sample %>

<div class="strategic-plan">
  <div class="container strategic-plan__container">

    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="#" class="breadcrumb-link">Dashboard</a></li>
        <li class="breadcrumb-item"><%= link_to "Análises", classifications_path, class: "breadcrumb-link" %></li>
        <li class="breadcrumb-item active" aria-current="page">Plano Estratégico</li>
      </ol>
    </nav>

    <div class="mb-4">
      <div class="d-flex align-items-center gap-3 mb-2">
        <%= link_to classifications_path, class: "strategic-plan__back" do %>←<% end %>

        <div>
          <p class="strategic-plan__category">
            <%= @classification.tag_category.presence || "Categoria" rescue "Categoria" %>
          </p>
          <h1 class="strategic-plan__title"><%= @classification.tag %></h1>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="pill pill--danger">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          <%= volume_pct %>% do volume
        </div>

        <div class="pill pill--neutral">
          <i class="bi bi-graph-up-arrow me-1"></i>
          <%= (@volume_change_pct.present? ? "+#{@volume_change_pct}%" : "+18%") %> vs. mês anterior
        </div>

        <div class="pill pill--ai">
          <i class="bi bi-stars me-1"></i>
          Análise por IA
        </div>
      </div>
    </div>

    <!-- Voz do Cliente + Gráfico -->
    <section class="mb-5">
      <div class="row g-4 align-items-stretch">

        <!-- GRÁFICO -->
        <div class="col-md-6">
          <div class="card p-4 shadow-sm h-100 strategic-card strategic-card--chart">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-1"><strong>Tendência de Volume</strong></h5>
                <p class="text-muted small mb-0">Últimos 30 dias</p>
              </div>

              <% if @volume_change_pct.present? %>
                <span class="badge rounded-pill px-3 py-2 badge-soft-danger">
                  ↑ <%= @volume_change_pct %>% aumento de volume
                </span>
              <% end %>
            </div>

            <div
              class="chart-wrap"
              data-controller="volume-chart"
              data-volume-chart-labels-value="<%= @volume_points.map { |p| p[:label] }.to_json %>"
              data-volume-chart-values-value="<%= @volume_points.map { |p| p[:count] }.to_json %>"
            >
              <canvas data-volume-chart-target="canvas"></canvas>
            </div>
          </div>
        </div>

        <!-- CARROSSEL -->
        <div class="col-md-6">
          <div class="card h-100 shadow-sm d-flex flex-column strategic-card">
            <div class="card-body d-flex flex-column">
              <h3 class="mb-1 voice-title">Voz do Cliente</h3>
              <p class="text-muted small mb-0">Conversas reais sobre o problema</p>


              <% if @conversations.present? %>
                <div id="conversationCarousel"
                     class="carousel slide position-relative flex-grow-1 conversation-carousel"
                     data-bs-ride="false">

                  <div class="carousel-inner h-100">
                    <% @conversations.each_with_index do |conversation, index| %>
                      <div class="carousel-item <%= 'active' if index == 0 %> h-100">
                        <div class="d-flex flex-column h-100">

                          <% mensagens_customer =
                            conversation.content.to_s.lines
                              .select { |linha| linha.strip.start_with?("[Customer]:") }
                              .map { |linha| linha.gsub("[Customer]:", "").strip }
                              .first(2)
                          %>

                          <div class="p-3 flex-grow-1 voice-quote-wrapper">
                          <svg class="quote-svg" xmlns="http://www.w3.org/2000/svg"
                              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 3H8a5 5 0 0 0-5 5v8a5 5 0 0 0 5 5h2v-8H7V8a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v13h2a5 5 0 0 0 5-5V8a5 5 0 0 0-5-5Z"/>
                          </svg>

                          <p class="voice-quote">"<%= mensagens_customer.join(' ') %>"</p>
                        </div>

                          <div class="px-3 py-3 border-top carousel-footer">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <div>
                                <p class="mb-0 voice-name">
                                  <%= ["Maria S.", "Carlos M.", "João P.", "Ana L.", "Aline K.",
                                       "Diego Z.", "Eduardo N.", "Thiago B."].sample %>
                                </p>
                                <p class="mb-0 text-muted d-flex align-items-center gap-1 voice-date">
                                  <i class="bi bi-calendar3"></i>
                                  <%= conversation.created_at.strftime("%d %b, %Y • %H:%M") %>
                                </p>
                              </div>

                              <span class="badge rounded-pill px-3 py-1 badge-soft-danger badge-emotion">
                                <%= ["Frustrado", "Confuso", "Aguardando", "Nervoso", "Preocupado"].sample %>
                              </span>
                            </div>

                            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                              <div class="d-flex flex-wrap gap-2">
                                <span class="badge rounded-pill px-3 py-1 badge-soft-success">
                                  <i class="bi bi-currency-dollar me-1"></i>
                                  R$ <%= rand(300..3500) %>
                                </span>

                                <span class="badge rounded-pill px-3 py-1 badge-soft-warn">
                                  <i class="bi bi-ticket-detailed me-1"></i>
                                  <%= rand(1..12) %> Tickets
                                </span>

                                <span class="badge rounded-pill px-3 py-1 badge-soft-gray">
                                  <i class="bi bi-crown me-1"></i>
                                  <%= ["Standard", "Enterprise", "Premium"].sample %>
                                </span>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    <% end %>
                  </div>

                  <button class="carousel-control-prev position-absolute" type="button"
                          data-bs-target="#conversationCarousel" data-bs-slide="prev">
                    <span class="carousel-arrow">❮</span>
                  </button>

                  <button class="carousel-control-next position-absolute" type="button"
                          data-bs-target="#conversationCarousel" data-bs-slide="next">
                    <span class="carousel-arrow">❯</span>
                  </button>

                </div>
              <% else %>
                <p class="text-muted text-center mt-4">Nenhuma conversa cadastrada para esta classificação.</p>
              <% end %>
            </div>
          </div>
        </div>

      </div>
    </section>

    <% if @ia_root_cause.present? %>
      <div class="card p-4 mb-4 root-cause-card">
        <span class="root-cause-card__accent"></span>

        <div class="root-cause-card__header">
          <h4 class="root-cause-card__title">Diagnóstico da Causa Raiz</h4>
          <p class="root-cause-card__sub">Análise baseada em IA</p>
        </div>

        <div class="root-cause-card__body">
          <p><%= @ia_root_cause %></p>
        </div>
      </div>
    <% end %>

    <!-- roadmap inicia aqui -->
<% if @improvement.present? %>
  <section class="mb-5 roadmap-section">
    <div class="roadmap-container">
      <span class="roadmap-accent"></span>
      <header class="roadmap-header">
        <h2>Roadmap Estratégico</h2>
        <p>Ações priorizadas por IA para resolver esse problema</p>
      </header>

      <% texto = @improvement.content.to_s %>
      <% curto = texto.split("Curto Prazo:").last&.split("Médio Prazo:")&.first %>
      <% medio = texto.split("Médio Prazo:").last&.split("Longo Prazo:")&.first %>
      <% longo = texto.split("Longo Prazo:").last %>

      <div class="row g-4 pt-2">
        <!-- curto prazo -->
        <div class="col-md-4">
          <div class="roadmap-card">
            <div class="roadmap-title">
              <span class="roadmap-icon roadmap-icon--short"><i class="fa-solid fa-bolt"></i></span>
              <div>
                <h3>Curto Prazo</h3>
                <p>1–2 semanas</p>
              </div>
            </div>

            <div class="d-flex flex-column gap-2">
              <% curto.to_s.lines.each do |linha| %>
                <% next unless linha.start_with?("-", "✅") %>
                <div class="roadmap-item">
                  <span class="roadmap-item__icon roadmap-icon--short"><i class="fa-solid fa-bolt"></i></span>
                  <span class="roadmap-item__text"><%= linha.gsub("✅","").gsub("-","").strip %></span>
                  <span class="badge rounded-pill badge-difficulty badge-difficulty--easy">Fácil</span>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- médio prazo -->
        <div class="col-md-4">
          <div class="roadmap-card">
            <div class="roadmap-title">
              <span class="roadmap-icon roadmap-icon--mid"><i class="fa-solid fa-sync"></i></span>
              <div>
                <h3>Médio Prazo</h3>
                <p>1–3 meses</p>
              </div>
            </div>

            <div class="d-flex flex-column gap-2">
              <% medio.to_s.lines.each do |linha| %>
                <% next unless linha.start_with?("-", "✅") %>
                <div class="roadmap-item">
                  <span class="roadmap-item__icon roadmap-icon--mid"><i class="fa-solid fa-sync"></i></span>
                  <span class="roadmap-item__text"><%= linha.gsub("✅","").gsub("-","").strip %></span>
                  <span class="badge rounded-pill badge-difficulty badge-difficulty--mid">Médio</span>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- longo prazo -->
        <div class="col-md-4">
          <div class="roadmap-card">
            <div class="roadmap-title">
              <span class="roadmap-icon roadmap-icon--long"><i class="fa-solid fa-rocket"></i></span>
              <div>
                <h3>Longo Prazo</h3>
                <p>3–12 meses</p>
              </div>
            </div>

            <div class="d-flex flex-column gap-2">
              <% longo.to_s.lines.each do |linha| %>
                <% next unless linha.start_with?("-", "✅") %>
                <div class="roadmap-item">
                  <span class="roadmap-item__icon roadmap-icon--long"><i class="fa-solid fa-rocket"></i></span>
                  <span class="roadmap-item__text"><%= linha.gsub("✅","").gsub("-","").strip %></span>
                  <span class="badge rounded-pill badge-difficulty badge-difficulty--hard">Complexo</span>
                </div>
              <% end %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
<% end %>
