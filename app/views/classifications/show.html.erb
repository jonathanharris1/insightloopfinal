<div style="background-color: #f5f5f7; min-height: 100vh; padding: 24px 0;">
  <div class="container" style="max-width: 1100px;">
      <% volume_options = [18, 25, 32, 45] %>
      <% volume_pct = volume_options.sample %>

    <!-- üîπ "Breadcrumb" / Caminho -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
          <a href="#">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
          <a href="#">An√°lises</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          Plano Estrat√©gico
        </li>
      </ol>
    </nav>
<!-- HEADER REESTRUTURADO (igual ao design da imagem) -->
<div class="mb-4">

  <!-- linha: seta + t√≠tulo -->
  <div class="d-flex align-items-center gap-3 mb-2">

    <!-- Bot√£o voltar -->
      <%= link_to classifications_path,
          class: "text-decoration-none",
           style: "font-size: 1.8rem; font-weight: 600; color: #333;" do %>
  ‚Üê
          <% end %>

    <div>
      <p class="text-muted mb-1" style="font-size: 0.9rem;">
        <%= @classification.tag_category.presence || "Categoria" rescue "Categoria" %>
      </p>
      <h1 class="mb-0" style="font-size: 1.9rem; font-weight: 700;">
        <%= @classification.tag %>
      </h1>
    </div>
  </div>

  <!-- linha: chips embaixo do t√≠tulo -->
  <div class="d-flex flex-wrap align-items-center gap-2">

    <!-- Chip % volume -->
    <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill"
         style="background: #fff0f0; color: #d64545; font-size: 0.8rem; font-weight: 600;">
      <i class="bi bi-exclamation-triangle-fill me-1"></i>
      <%= volume_pct %>% do volume
    </div>

    <!-- Chip tend√™ncia -->
    <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill border"
         style="font-size: 0.8rem; color: #555;">
      <i class="bi bi-graph-up-arrow me-1"></i>
      <%= (@volume_change_pct.present? ? "+#{@volume_change_pct}%" : "+18%") %> vs. m√™s anterior
    </div>

    <!-- Chip "An√°lise por IA" -->
    <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill border"
         style="font-size: 0.8rem; background: #f3ebff; color: #7a3ff2; border-color: #e1d4ff;">
      <i class="bi bi-stars me-1"></i>
      An√°lise por IA
    </div>

  </div>

</div>


    <!-- üîπ Se√ß√£o: A Voz do Cliente -->
    <section class="mb-5">


      <div class="row g-4 align-items-stretch">

        <!-- üü£ ESQUERDA: Tend√™ncia de volume -->
        <div class="col-lg-6">
          <div class="card h-100 shadow-sm border-0"
               style="border-radius: 16px; background: #ffffff;">
            <div class="card-body d-flex flex-column">

              <!-- T√≠tulo + badge aumento -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h3 class="mb-1" style="font-size: 0.95rem; font-weight: 600;">
                    Tend√™ncia de Volume
                  </h3>
                  <p class="text-muted mb-0" style="font-size: 0.8rem;">
                    √öltimos 30 dias
                  </p>
                </div>

                <% if @volume_change_pct.present? %>
                  <span class="badge rounded-pill px-3 py-2"
                        style="background:#ffecec; color:#d64545; font-size: 0.75rem;">
                    ‚Üë <%= @volume_change_pct %>% aumento de volume
                  </span>
                <% else %>
                  <span class="badge rounded-pill px-3 py-2"
                        style="background:#ffecec; color:#d64545; font-size: 0.75rem;">
                    ‚Üë 18% aumento de volume
                  </span>
                <% end %>
              </div>

              <!-- "alerta" pequeno embaixo do t√≠tulo -->


              <!-- GR√ÅFICO -->
              <div style="height: 200px;">
                <canvas id="volumeTrendChart-<%= @classification.id %>"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- üü£ DIREITA: Carrossel "Voz do Cliente" -->
        <div class="col-lg-6">
          <div class="card h-100 shadow-sm border-0 d-flex flex-column"
               style="border-radius: 16px; background: #ffffff;">

            <div class="card-body d-flex flex-column">
              <h3 class="mb-3" style="font-size: 0.95rem; font-weight: 600;">
                Voz do Cliente
              </h3>

              <% if @conversations.present? %>
                <div id="conversationCarousel"
                     class="carousel slide position-relative flex-grow-1"
                     data-bs-ride="false">

                  <div class="carousel-inner h-100">

                    <% @conversations.each_with_index do |conversation, index| %>
                      <div class="carousel-item <%= 'active' if index == 0 %> h-100">
                        <div class="d-flex flex-column h-100">

                          <!-- √çcone de aspas + texto -->
                          <div class="p-3 flex-grow-1">
                            <div class="mb-3" style="opacity: 0.2;">
                              <i class="bi bi-quote" style="font-size: 2rem;"></i>
                            </div>

                            <% mensagens_customer =
                              conversation.content
                                         .to_s
                                         .lines
                                         .select { |linha| linha.strip.start_with?("[Customer]:") }
                                         .map   { |linha| linha.gsub("[Customer]:", "").strip }
                                         .first(2)
                            %>

                            <p class="text-dark fst-italic"
                               style="font-size: 0.95rem; line-height: 1.5;">
                              "<%= mensagens_customer.join(' ') %>"
                            </p>
                          </div>

                          <!-- Rodap√© da conversa -->
                          <div class="px-3 py-3 border-top"
                               style="background:#f8f9fb; border-radius: 0 0 16px 16px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <div>
                                <p class="mb-0" style="font-weight: 600; font-size: 0.9rem;">
                                  <%= ["Maria S.", "Carlos M.", "Jo√£o P.", "Ana L.", "Aline K.",
                                       "Diego Z.", "Eduardo N.", "Thiago B."].sample %>
                                </p>
                                <p class="mb-0 text-muted d-flex align-items-center gap-1"
                                   style="font-size: 0.75rem;">
                                  <i class="bi bi-calendar3"></i>
                                  <%= conversation.created_at.strftime("%d %b, %Y ‚Ä¢ %H:%M") %>
                                </p>
                              </div>

                              <span class="badge rounded-pill px-3 py-1"
                                    style="background:#fff0f0; color:#d64545; font-size:0.75rem;">
                                <%= ["Frustrado", "Confuso", "Aguardando", "Nervoso", "Preocupado"].sample %>
                              </span>
                            </div>

                            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                              <div class="d-flex flex-wrap gap-2">
                                <span class="badge rounded-pill px-3 py-1"
                                      style="background:#eafaf1; color:#146c43; font-size:0.75rem;">
                                  <i class="bi bi-currency-dollar me-1"></i>
                                  R$ <%= rand(300..3500) %>
                                </span>

                                <span class="badge rounded-pill px-3 py-1"
                                      style="background:#fff7e6; color:#b96b00; font-size:0.75rem;">
                                  <i class="bi bi-ticket-detailed me-1"></i>
                                  <%= rand(1..12) %> Tickets
                                </span>

                                <span class="badge rounded-pill px-3 py-1"
                                      style="background:#e9ecef; color:#495057; font-size:0.75rem;">
                                  <i class="bi bi-crown me-1"></i>
                                  <%= ["Standard", "Enterprise", "Premium"].sample %>
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>

                  <!-- Bot√µes do carrossel (setas) -->
                  <button class="carousel-control-prev position-absolute"
                          type="button"
                          data-bs-target="#conversationCarousel"
                          data-bs-slide="prev"
                          style="
                            top: 50%;
                            left: -2px;
                            transform: translateY(-50%);
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          ">
                    <span style="font-size: 24px; color: black;">‚ùÆ</span>
                  </button>

                  <button class="carousel-control-next position-absolute"
                          type="button"
                          data-bs-target="#conversationCarousel"
                          data-bs-slide="next"
                          style="
                            top: 50%;
                            right: -2px;
                            transform: translateY(-50%);
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          ">
                    <span style="font-size: 24px; color: black;">‚ùØ</span>
                  </button>
                </div>
              <% else %>
                <p class="text-muted text-center mt-4">
                  Nenhuma conversa cadastrada para esta classifica√ß√£o.
                </p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </section>

      <div class="card p-4 shadow-sm my-4" style="border-radius: 14px;">

           <% if @ia_root_cause.present? %>
           <div class="card p-4 shadow-sm mb-4">
             <h4><strong>Diagn√≥stico da Causa Raiz</strong></h4>
                 <p class="text-muted small">An√°lise baseada em IA</p>
                  <p><%= @ia_root_cause %></p>
                 </div>
             <% end %>



    <!-- üîπ ROADMAP ESTRAT√âGICO -->
    <section class="mb-5">
      <div class="text-center mb-3 mt-4">
        <h2 style="font-size: 1.2rem; font-weight: 600;">Roadmap Estrat√©gico</h2>
        <p class="text-muted" style="font-size: 0.9rem;">
          A√ß√µes priorizadas por IA para resolver esse problema
        </p>
      </div>

      <% texto = @improvement.content.to_s %>
      <% curto = texto.split("Curto Prazo:").last&.split("M√©dio Prazo:")&.first %>
      <% medio = texto.split("M√©dio Prazo:").last&.split("Longo Prazo:")&.first %>
      <% longo = texto.split("Longo Prazo:").last %>



      <!-- 3 colunas -->
      <div class="row g-4 pt-2">

        <!-- Curto Prazo -->
        <div class="col-md-4">
          <div class="h-100 d-flex flex-column">
            <div class="d-flex align-items-center gap-2 mb-3">
              <div class="d-flex align-items-center justify-content-center"
                   style="width: 32px; height: 32px; border-radius: 10px; background:#e6f6ed;">
                <i class="bi bi-lightning-charge-fill" style="color:#198754;"></i>
              </div>
              <div>
                <h3 class="mb-0" style="font-size: 0.9rem; font-weight: 600;">Curto Prazo</h3>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">1‚Äì2 semanas</p>
              </div>
            </div>

            <div class="d-flex flex-column gap-2">

              <% curto.to_s.lines.each do |linha| %>
                <% next unless linha.start_with?("-") || linha.start_with?("‚úÖ") %>
                <div class="d-flex align-items-center gap-3 p-3 rounded"
                     style="background:#ffffff; border-radius: 12px; border: 1px solid #f0f0f0; cursor:pointer;">
                  <div class="d-flex align-items-center justify-content-center flex-shrink-0"
                       style="width: 32px; height: 32px; border-radius: 8px; background:#f1f3f5;">
                    <i class="bi bi-file-earmark-text"></i>
                  </div>
                  <span class="flex-grow-1"
                        style="font-size: 0.85rem; font-weight: 500;">
                    <%= linha.gsub("‚úÖ", "").gsub("-", "").strip %>
                  </span>
                  <span class="badge rounded-pill px-2 py-1"
                        style="background:#e6f6ed; color:#198754; font-size:0.7rem;">
                    F√°cil
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- M√©dio Prazo -->
        <div class="col-md-4">
          <div class="h-100 d-flex flex-column">
            <div class="d-flex align-items-center gap-2 mb-3">
              <div class="d-flex align-items-center justify-content-center"
                   style="width: 32px; height: 32px; border-radius: 10px; background:#e7f0ff;">
                <i class="bi bi-bullseye" style="color:#0d6efd;"></i>
              </div>
              <div>
                <h3 class="mb-0" style="font-size: 0.9rem; font-weight: 600;">M√©dio Prazo</h3>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">1‚Äì3 meses</p>
              </div>
            </div>

            <div class="d-flex flex-column gap-2">
              <% medio.to_s.lines.each do |linha| %>
                <% next unless linha.start_with?("-") || linha.start_with?("‚úÖ") %>
                <div class="d-flex align-items-center gap-3 p-3 rounded"
                     style="background:#ffffff; border-radius: 12px; border: 1px solid #f0f0f0; cursor:pointer;">
                  <div class="d-flex align-items-center justify-content-center flex-shrink-0"
                       style="width: 32px; height: 32px; border-radius: 8px; background:#f1f3f5;">
                    <i class="bi bi-graph-up-arrow"></i>
                  </div>
                  <span class="flex-grow-1"
                        style="font-size: 0.85rem; font-weight: 500;">
                    <%= linha.gsub("‚úÖ", "").gsub("-", "").strip %>
                  </span>
                  <span class="badge rounded-pill px-2 py-1"
                        style="background:#e7f0ff; color:#0d6efd; font-size:0.7rem;">
                    M√©dio
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Longo Prazo -->
        <div class="col-md-4">
          <div class="h-100 d-flex flex-column">
            <div class="d-flex align-items-center gap-2 mb-3">
              <div class="d-flex align-items-center justify-content-center"
                   style="width: 32px; height: 32px; border-radius: 10px; background:#ffecec;">
                <i class="bi bi-buildings" style="color:#d64545;"></i>
              </div>
              <div>
                <h3 class="mb-0" style="font-size: 0.9rem; font-weight: 600;">Longo Prazo</h3>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">3‚Äì12 meses</p>
              </div>
            </div>

            <div class="d-flex flex-column gap-2">
              <% longo.to_s.lines.each do |linha| %>
                <% next unless linha.start_with?("-") || linha.start_with?("‚úÖ") %>
                <div class="d-flex align-items-center gap-3 p-3 rounded"
                     style="background:#ffffff; border-radius: 12px; border: 1px solid #f0f0f0; cursor:pointer;">
                  <div class="d-flex align-items-center justify-content-center flex-shrink-0"
                       style="width: 32px; height: 32px; border-radius: 8px; background:#f1f3f5;">
                    <i class="bi bi-building"></i>
                  </div>
                  <span class="flex-grow-1"
                        style="font-size: 0.85rem; font-weight: 500;">
                    <%= linha.gsub("‚úÖ", "").gsub("-", "").strip %>
                  </span>
                  <span class="badge rounded-pill px-2 py-1"
                        style="background:#ffecec; color:#d64545; font-size:0.7rem;">
                    Complexo
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

    </section>
  </div>
</div>

<!-- üîπ SCRIPT DO GR√ÅFICO (Chart.js precisa estar carregado no layout) -->
<script>
  function renderVolumeChart() {
    const canvasId = "volumeTrendChart-<%= @classification.id %>";
    const canvas   = document.getElementById(canvasId);
    if (!canvas || typeof Chart === "undefined") return;

    if (canvas._chartInstance) {
      canvas._chartInstance.destroy();
    }

    const labels     = <%= raw @volume_points.map { |p| p[:label] }.to_json %>;
    const dataValues = <%= raw @volume_points.map { |p| p[:count] }.to_json %>;

    const chart = new Chart(canvas, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          data: dataValues,
          fill: true,
          tension: 0.4,
          borderColor: "#f04438",
          backgroundColor: "rgba(240, 68, 56, 0.10)",
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(0,0,0,0.05)" },
            ticks: { precision: 0 }
          }
        }
      }
    });

    canvas._chartInstance = chart;
  }

  document.addEventListener("turbo:load", renderVolumeChart);
  document.addEventListener("DOMContentLoaded", renderVolumeChart);
</script>
