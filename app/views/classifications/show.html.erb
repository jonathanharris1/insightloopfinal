<div class="d-flex align-items-center justify-content-center gap-3 mb-3">

<h1><%= @classification.tag %></h1>
  <!-- SETA DE VOLTAR -->
  <%= link_to classifications_path, class: "text-dark fs-3 text-decoration-none" do %>
    â†
  <% end %>

  <!-- TÃTULO -->
  <h1 class="mb-0"><%= @classification.tag %></h1>

</div>

<!-- BLOCO SUPERIOR: GRÃFICO + CARROSSEL -->
<div class="container mt-4 mb-5">
  <div class="row align-items-stretch">

<!-- ESQUERDA: GRÃFICO + INFO -->
<div class="col-md-6">
  <div class="card p-4 shadow-sm h-100" style="min-height: 300px;">

    <!-- TÃ­tulo + badge de aumento -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h5 class="mb-1">TendÃªncia de Volume</h5>
        <p class="text-muted small mb-0">Ãšltimos 30 dias</p>
      </div>

      <% if @volume_change_pct.present? %>
        <span class="badge rounded-pill px-3 py-2" style="background:#ffecec; color:#d64545;">
          â†‘ <%= @volume_change_pct %>% aumento de volume
        </span>
      <% end %>
    </div>

    <!-- GRÃFICO -->
    <div style="height: 260px;">
      <canvas id="volumeTrendChart-<%= @classification.id %>"></canvas>
    </div>
  </div>
</div>

<script>
  function renderVolumeChart() {
    const canvasId = "volumeTrendChart-<%= @classification.id %>";
    const ctx = document.getElementById(canvasId);

    // Se nÃ£o achar o canvas ou Chart.js nÃ£o estiver pronto, aborta
    if (!ctx || !window.Chart) return;

    // Evita recriar o grÃ¡fico se a pÃ¡gina for reprocessada pelo Turbo
    if (ctx.dataset.chartInitialized === "true") return;
    ctx.dataset.chartInitialized = "true";

    const labels = <%= raw @volume_points.map { |p| p[:label] }.to_json %>;
    const dataValues = <%= raw @volume_points.map { |p| p[:count] }.to_json %>;

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          data: dataValues,
          fill: true,
          tension: 0.4, // curva suave
          borderColor: "#f04438",
          backgroundColor: "rgba(240, 68, 56, 0.10)",
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(0, 0, 0, 0.04)" },
            ticks: { precision: 0 }
          }
        }
      }
    });
  }

  // Faz funcionar tanto no primeiro load quanto nas navegaÃ§Ãµes Turbo
  document.addEventListener("DOMContentLoaded", renderVolumeChart);
  document.addEventListener("turbo:load", renderVolumeChart);
</script>

    <!-- DIREITA: CARROSSEL -->
    <div class="col-md-6">
      <div class="card p-4 shadow-sm h-100" style="min-height: 280px;">
        <h5 class="text-muted">ğŸ—£ï¸ Voz do Cliente</h5>

        <% if @conversations.any? %>

          <div id="conversationCarousel"
               class="carousel slide position-relative"
               data-bs-ride="carousel">

            <div class="carousel-inner">

              <% @conversations.each_with_index do |conversation, index| %>

                <div class="carousel-item <%= 'active' if index == 0 %>">
                  <div class="p-3">

                    <!-- APENAS 2 MENSAGENS DO CUSTOMER -->
                    <% mensagens_customer =
                        conversation.content
                                   .to_s
                                   .lines
                                   .select { |linha| linha.strip.start_with?("[Customer]:") }
                                   .map   { |linha| linha.gsub("[Customer]:", "").strip }
                                   .first(2)
                    %>

                    <p class="fst-italic" style="white-space: pre-line; font-size: 1rem;">
                      â€œ<%= mensagens_customer.join("\n") %>â€
                    </p>

                    <hr>

                    <!-- RODAPÃ‰ -->
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <strong><%= ["Carlos M.", "Maria S.", "JoÃ£o P.", "Ana L.", "Aline K.", "Diego Z.", "Eduardo N.", "Thiago B."].sample %></strong><br> <!-- Nomes aleatorios -->
                        <small><%= conversation.created_at.strftime("%d %b, %Y â€¢ %H:%M") %></small>
                      </div>

                      <span class="badge rounded-pill bg-light text-primary border">
                        <%= ["Confuso", "Frustrado", "Aguardando", "Nervoso", "Preocupado" ].sample %>
                      </span>
                    </div>

                    <!-- BADGES DE BAIXO -->
                    <div class="d-flex gap-2 mt-3 flex-wrap">
                      <span class="badge bg-success">
                        R$ <%= rand(300..3500) %> <!--Aqui gera um nÃºmero aleatÃ³rio entre 300 e 3500 toda vez que a pÃ¡gina carrega.-->
                      </span>

                      <span class="badge bg-secondary">
                        <%= rand(1..12) %> Tickets  <!-- gera um nÃºmero aleatÃ³rio de 1 a 12.-->
                      </span>

                      <span class="badge bg-light text-dark border">
                        <%= ["Standard", "Enterprise", "Premium"].sample %>
                      </span>
                    </div>

                  </div>
                </div>

              <% end %>
            </div>

            <!-- BOTÃƒO ESQUERDA - COLADO NA LATERAL -->
            <button class="carousel-control-prev position-absolute"
                    type="button"
                    data-bs-target="#conversationCarousel"
                    data-bs-slide="prev"
                    style="
                      top: 50%;
                      left: -2px;
                      transform: translateY(-50%);
                      width: 30px;
                      height: 30px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    ">
              <span style="font-size: 26px; color: black;">â®</span>
            </button>

            <!-- BOTÃƒO DIREITA - COLADO NA LATERAL -->
            <button class="carousel-control-next position-absolute"
                    type="button"
                    data-bs-target="#conversationCarousel"
                    data-bs-slide="next"
                    style="
                      top: 50%;
                      right: -2px;
                      transform: translateY(-50%);
                      width: 30px;
                      height: 30px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    ">
              <span style="font-size: 26px; color: black;">â¯</span>
            </button>

          </div>

        <% else %>

          <p class="text-muted text-center mt-4">
            Nenhuma conversa cadastrada para esta classificaÃ§Ã£o.
          </p>

        <% end %>

      </div>
    </div>

  </div>
</div>

<!-- ROADMAP -->
<h2 class="text-center fw-bold mt-5">Roadmap EstratÃ©gico</h2>
<p class="text-center text-muted mb-4">
  AÃ§Ãµes priorizadas por IA para resolver esse problema
</p>

<% texto = @improvement.content.to_s %>
<% curto = texto.split("Curto Prazo:").last&.split("MÃ©dio Prazo:")&.first %>
<% medio = texto.split("MÃ©dio Prazo:").last&.split("Longo Prazo:")&.first %>
<% longo = texto.split("Longo Prazo:").last %>

<div class="row mt-4 mb-5 d-flex align-items-stretch">

  <!-- CURTO PRAZO -->
  <div class="col-md-4">
    <div class="card p-3 shadow-sm h-100">
      <h5 class="fw-bold">âš¡ Curto Prazo</h5>
      <small class="text-muted">1â€“2 semanas</small>
      <hr>

      <% curto.to_s.lines.each do |linha| %>
        <% next unless linha.start_with?("-") || linha.start_with?("âœ…") %>
        <div class="d-flex align-items-center mb-2">
          <span class="me-2">ğŸ“„</span>
          <span><%= linha.gsub("âœ…", "").gsub("-", "").strip %></span>
          <span class="badge bg-success ms-auto">FÃ¡cil</span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- MÃ‰DIO PRAZO -->
  <div class="col-md-4">
    <div class="card p-3 shadow-sm h-100">
      <h5 class="fw-bold">ğŸ¯ MÃ©dio Prazo</h5>
      <small class="text-muted">1â€“3 meses</small>
      <hr>

      <% medio.to_s.lines.each do |linha| %>
        <% next unless linha.start_with?("-") || linha.start_with?("âœ…") %>
        <div class="d-flex align-items-center mb-2">
          <span class="me-2">ğŸ“„</span>
          <span><%= linha.gsub("âœ…", "").gsub("-", "").strip %></span>
          <span class="badge bg-warning ms-auto">MÃ©dio</span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- LONGO PRAZO -->
  <div class="col-md-4">
    <div class="card p-3 shadow-sm h-100">
      <h5 class="fw-bold">ğŸ—ï¸ Longo Prazo</h5>
      <small class="text-muted">3â€“12 meses</small>
      <hr>

      <% longo.to_s.lines.each do |linha| %>
        <% next unless linha.start_with?("-") || linha.start_with?("âœ…") %>
        <div class="d-flex align-items-center mb-2">
          <span class="me-2">ğŸ“„</span>
          <span><%= linha.gsub("âœ…", "").gsub("-", "").strip %></span>
          <span class="badge bg-danger ms-auto">Complexo</span>
        </div>
      <% end %>
    </div>
  </div>

</div>
